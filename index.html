<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>株価運用実績比較</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h2>株価運用実績（過去1年・実際の投資金額ベース）</h2>
  <canvas id="portfolioChart" width="1200" height="600"></canvas>

  <script>
  // 銘柄コードと購入金額
  const portfolio = [
    {code: "1384.T", name:"ホクリヨウ", amount:250000},
    {code: "1382.T", name:"ホーブ", amount:230000},
    {code: "1379.T", name:"ホクト", amount:260000},
    {code: "1377.T", name:"サカタのタネ", amount:270000},
    {code: "1380.T", name:"秋川牧園", amount:240000},
    {code: "2593.T", name:"伊藤園", amount:270000},
    {code: "2226.T", name:"湖池屋", amount:240000},
    {code: "2910.T", name:"ロック・フィールド", amount:260000},
    {code: "2923.T", name:"サトウ食品", amount:250000},
    {code: "1381.T", name:"アクシーズ", amount:230000},
    {code: "4680.T", name:"ラウンドワン", amount:240000},
    {code: "2305.T", name:"スタジオアリス", amount:230000},
    {code: "9708.T", name:"帝国ホテル", amount:270000},
    {code: "6819.T", name:"伊豆シャボテンリゾート", amount:250000},
    {code: "2485.T", name:"ティア", amount:260000},
    {code: "9602.T", name:"東宝", amount:240000},
    {code: "9697.T", name:"カプコン", amount:260000},
    {code: "3635.T", name:"コーエーテクモHD", amount:230000}
  ];

  // インデックス
  const indices = ["^N225", "^TOPX"]; 

  async function fetchStockData(symbol) {
    const endDate = Math.floor(Date.now() / 1000);
    const startDate = endDate - 365*24*60*60; // 過去1年
    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${startDate}&period2=${endDate}&interval=1d`;

    try {
      const res = await fetch(url);
      const data = await res.json();
      if(data.chart && data.chart.result){
        const timestamps = data.chart.result[0].timestamp;
        const prices = data.chart.result[0].indicators.quote[0].close;
        const labels = timestamps.map(ts => new Date(ts*1000).toLocaleDateString());
        return {symbol, labels, prices};
      } else {
        console.warn(symbol + "のデータ取得に失敗しました");
        return {symbol, labels: [], prices: []};
      }
    } catch(e) {
      console.error(symbol + "の取得エラー:", e);
      return {symbol, labels: [], prices: []};
    }
  }

  function getRandomColor() {
    const r = Math.floor(Math.random()*200);
    const g = Math.floor(Math.random()*200);
    const b = Math.floor(Math.random()*200);
    return `rgb(${r},${g},${b})`;
  }

  async function drawChart() {
    const symbols = [...portfolio.map(p => p.code), ...indices];
    const datasets = [];
    let labels = [];

    for(const sym of symbols){
      const stockData = await fetchStockData(sym);
      if(stockData.prices.length === 0) continue;

      if(labels.length === 0) labels = stockData.labels;

      let dataForChart = [];

      // 銘柄の場合は購入金額ベースで運用資産計算
      const portItem = portfolio.find(p => p.code === sym);
      if(portItem){
        const shares = portItem.amount / stockData.prices[0]; // 株数
        dataForChart = stockData.prices.map(p => p * shares); // 資産価値推移
      } else {
        // 指数の場合は初日を1万円換算
        const first = stockData.prices[0];
        dataForChart = stockData.prices.map(p => p / first * 10000);
      }

      datasets.push({
        label: portItem ? portItem.name : sym,
        data: dataForChart,
        borderColor: getRandomColor(),
        fill: false,
        tension: 0.1
      });
    }

    const ctx = document.getElementById('portfolioChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' },
          title: { display: true, text: '過去1年の運用実績（購入金額ベース）' }
        },
        scales: {
          y: { beginAtZero: false, title: { display: true, text: '資産価値（円）' } }
        }
      }
    });
  }

  drawChart();
  </script>
</body>
</html>
