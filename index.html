<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>株価運用実績比較</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h2>株価運用実績（過去1年）</h2>
  <canvas id="portfolioChart" width="1200" height="600"></canvas>

  <script>
  const selectedTickers = [
    "1384.T", "1382.T", "1379.T", "1377.T", "1380.T",
    "2593.T", "2226.T", "2910.T", "2923.T", "1381.T",
    "4680.T", "2305.T", "9708.T", "6819.T", "2485.T",
    "9602.T", "9697.T", "3635.T"
  ];

  const indices = ["^N225", "^TOPX"]; 

  async function fetchStockData(symbol) {
    const endDate = Math.floor(Date.now() / 1000);
    const startDate = endDate - 365*24*60*60; // 過去1年
    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${startDate}&period2=${endDate}&interval=1d`;

    try {
      const res = await fetch(url);
      const data = await res.json();
      if(data.chart && data.chart.result){
        const timestamps = data.chart.result[0].timestamp;
        const prices = data.chart.result[0].indicators.quote[0].close;
        const labels = timestamps.map(ts => new Date(ts*1000).toLocaleDateString());
        return {symbol, labels, prices};
      } else {
        console.warn(symbol + "のデータ取得に失敗しました");
        return {symbol, labels: [], prices: []};
      }
    } catch(e) {
      console.error(symbol + "の取得エラー:", e);
      return {symbol, labels: [], prices: []};
    }
  }

  function getRandomColor() {
    const r = Math.floor(Math.random()*200);
    const g = Math.floor(Math.random()*200);
    const b = Math.floor(Math.random()*200);
    return `rgb(${r},${g},${b})`;
  }

  async function drawChart() {
    const symbols = [...selectedTickers, ...indices];
    const datasets = [];
    let labels = [];

    for(const sym of symbols){
      const stockData = await fetchStockData(sym);
      if(stockData.prices.length === 0) continue;

      if(labels.length === 0) labels = stockData.labels;

      // --- 運用実績計算 ---
      const initialPrice = stockData.prices[0];
      const initialInvestment = 10000; // 1銘柄1万円投資
      const shares = initialInvestment / initialPrice;

      // 日次資産価値
      const portfolioValue = stockData.prices.map(p => shares * p);

      // 指数は1日目を1にして正規化
      let dataForChart = portfolioValue;
      if(sym.startsWith("^")) {
        const first = stockData.prices[0];
        dataForChart = stockData.prices.map(p => p / first * 10000); // 初期1万円換算
      }

      datasets.push({
        label: stockData.symbol,
        data: dataForChart,
        borderColor: getRandomColor(),
        fill: false,
        tension: 0.1
      });
    }

    const ctx = document.getElementById('portfolioChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' },
          title: { display: true, text: '過去1年の運用実績（1銘柄1万円投資換算）' }
        },
        scales: {
          y: { beginAtZero: false, title: { display: true, text: '資産価値（円）' } }
        }
      }
    });
  }

  drawChart();
  </script>
</body>
</html>
